require('dotenv').config();
const express = require('express');
const cors = require('cors');
const mongoose = require('mongoose');
const portfinder = require('portfinder');
const User = require('./models/User');

const app = express();

// Middleware
app.use(express.json());
app.use(cors());

// DEBUG pour voir si `MONGO_URI` est bien charg√©
console.log("üîç DEBUG: Tentative de connexion √† MongoDB avec l'URI:", process.env.MONGO_URI ? `${process.env.MONGO_URI.substring(0, 20)}...` : "Non d√©fini");

// Connexion √† MongoDB
mongoose.connect(process.env.MONGO_URI, {
    useNewUrlParser: true,
    useUnifiedTopology: true
})
    .then(() => console.log('‚úÖ Connexion √† MongoDB √©tablie'))
    .catch(err => console.error('‚ùå Erreur de connexion √† MongoDB:', err));

// Test API
app.get('/test', (req, res) => res.json({ message: "‚úÖ Le serveur fonctionne bien !" }));

// R√©cup√©rer tous les utilisateurs
app.get('/api/users', async (req, res) => {
    try {
        const users = await User.find({}, '-password');
        res.json(users);
    } catch (error) {
        res.status(500).json({ error: "‚ùå Erreur lors de la r√©cup√©ration des utilisateurs" });
    }
});

// R√©cup√©rer un utilisateur par ID
app.get('/api/users/:id', async (req, res) => {
    try {
        const user = await User.findById(req.params.id, '-password');
        user ? res.json(user) : res.status(404).json({ error: "‚ùå Utilisateur non trouv√©" });
    } catch (error) {
        res.status(500).json({ error: "‚ùå Erreur lors de la r√©cup√©ration de l'utilisateur" });
    }
});

// Cr√©er un nouvel utilisateur
app.post('/api/users', async (req, res) => {
    try {
        const { username, name, email, password } = req.body;
        if (!username || !email || !password) return res.status(400).json({ error: "‚ùå Tous les champs sont requis" });

        const newUser = new User({ username, name, email, password });
        await newUser.save();
        res.status(201).json({ message: "‚úÖ Utilisateur cr√©√© avec succ√®s !" });
    } catch (error) {
        res.status(500).json({ error: "‚ùå Erreur lors de la cr√©ation de l'utilisateur" });
    }
});

// Mettre √† jour un utilisateur
app.put('/api/users/:id', async (req, res) => {
    try {
        const { username, name, email } = req.body;
        const user = await User.findByIdAndUpdate(req.params.id, { username, name, email }, { new: true });
        user ? res.json(user) : res.status(404).json({ error: "‚ùå Utilisateur non trouv√©" });
    } catch (error) {
        res.status(500).json({ error: "‚ùå Erreur lors de la mise √† jour de l'utilisateur" });
    }
});

// Supprimer un utilisateur
app.delete('/api/users/:id', async (req, res) => {
    try {
        const user = await User.findByIdAndDelete(req.params.id);
        user ? res.json({ message: "‚úÖ Utilisateur supprim√©", user }) : res.status(404).json({ error: "‚ùå Utilisateur non trouv√©" });
    } catch (error) {
        res.status(500).json({ error: "‚ùå Erreur lors de la suppression de l'utilisateur" });
    }
});

// Gestion des routes inexistantes
app.use((req, res) => res.status(404).json({ error: "‚ùå Route introuvable" }));

// Trouver un port disponible et d√©marrer le serveur
portfinder.basePort = process.env.PORT || 3000;

portfinder.getPort((err, availablePort) => {
    if (err) {
        console.error('‚ùå Erreur lors de la recherche d\'un port disponible:', err);
        return;
    }

    app.listen(availablePort, () => {
        console.log(`‚úÖ Serveur backend d√©marr√© sur http://localhost:${availablePort}`);
    });
});
